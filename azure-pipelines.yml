trigger:
  branches:
    include: [ main ]
  paths:
    include: [ app/*, frontend/*, infra/*, Dockerfile ]

pool:
  name: 'Default'

variables:
  dockerId: 'TU_USUARIO_DOCKERHUB'
  dockerConnection: 'DockerHubConn'
  azureConnection: 'AzureRMConn' 
  
  # Solo una imagen y una app
  imageName: 'fastapi-react-unified'
  appName: 'app-unified-demo1'
  
  # Variables Infra (Igual que antes)
  tfStateRg: 'rg-terraform-state'
  tfStateStorageAccount: 'tfstate123456' 
  tfStateContainer: 'tfstate'
  tfStateKey: 'terraform.tfstate'
  projectSuffix: 'demo1'
  resourceGroup: 'rg-fastapi-demo1'

stages:
# STAGE 1: BUILD & PUSH (UNIFICADO)
- stage: Build
  displayName: 'Build Unified Image'
  jobs:
  - job: BuildUnified
    displayName: 'Build Full Stack'
    steps:
    - task: Docker@2
      displayName: 'Build & Push Docker Image'
      inputs:
        containerRegistry: $(dockerConnection)
        repository: $(dockerId)/$(imageName)
        command: 'buildAndPush'
        # Usamos el Dockerfile de la raíz
        Dockerfile: 'Dockerfile' 
        # IMPORTANTE: El contexto debe ser la raíz (.) para ver /app y /frontend
        buildContext: '.' 
        tags: |
          latest
          $(Build.BuildId)

# STAGE 2: INFRASTRUCTURE
- stage: Infrastructure
  displayName: 'Deploy Infra'
  dependsOn: Build
  jobs:
  - job: Terraform
    steps:
    - task: TerraformInstaller@1
      inputs: { terraformVersion: 'latest' }
    
    - task: TerraformTaskV4@4
      displayName: 'TF Init'
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(System.DefaultWorkingDirectory)/infra'
        backendServiceArm: '$(azureConnection)'
        backendAzureRmResourceGroupName: '$(tfStateRg)'
        backendAzureRmStorageAccountName: '$(tfStateStorageAccount)'
        backendAzureRmContainerName: '$(tfStateContainer)'
        backendAzureRmKey: '$(tfStateKey)'

    - task: TerraformTaskV4@4
      displayName: 'TF Apply'
      inputs:
        provider: 'azurerm'
        command: 'apply'
        workingDirectory: '$(System.DefaultWorkingDirectory)/infra'
        environmentServiceNameAzureRM: '$(azureConnection)'
        # Quitamos la variable frontend_image
        commandOptions: '-auto-approve -var "project_suffix=$(projectSuffix)" -var "backend_image=$(dockerId)/$(imageName):latest" -var "db_pass=$(DB_PASSWORD)"'
      env:
        DB_PASSWORD: $(DB_PASSWORD)

# STAGE 3: DEPLOY
- stage: Deploy
  displayName: 'Update App'
  dependsOn: Infrastructure
  jobs:
  - job: DeployApp
    steps:
    - task: AzureContainerApps@1
      displayName: 'Deploy Unified App'
      inputs:
        azureSubscription: '$(azureConnection)'
        imageToDeploy: '$(dockerId)/$(imageName):$(Build.BuildId)'
        containerAppName: '$(appName)'
        resourceGroup: '$(resourceGroup)'
