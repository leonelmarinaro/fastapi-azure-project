name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - dev
    paths:
      - 'app/**'
      - 'frontend/**'
      - 'infra/**'
      - 'Dockerfile'
      - '.github/workflows/deploy.yml'
  workflow_dispatch: # Permite ejecutar manualmente

env:
  # Configuraci칩n Global
  IMAGE_NAME: 'fastapi-react-unified'
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  PROJECT_SUFFIX: 'demo1'

jobs:
  # --- TRABAJO 1: BUILD & PUSH ---
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c칩digo
        uses: actions/checkout@v4

      - name: Login en Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build y Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

  # --- TRABAJO 2: INFRAESTRUCTURA Y DESPLIEGUE ---
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}
    steps:
      - name: Checkout c칩digo
        uses: actions/checkout@v4

      # 1. Definir entorno (Dev vs Prod)
      - name: Configurar Variables de Entorno Din치micas
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "ENV_NAME=prod" >> $GITHUB_ENV
            echo "TF_KEY=prod.terraform.tfstate" >> $GITHUB_ENV
          else
            echo "ENV_NAME=dev" >> $GITHUB_ENV
            echo "TF_KEY=dev.terraform.tfstate" >> $GITHUB_ENV
          fi

      # 2. Login en Azure (Necesario para Terraform y Deploy)
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 3. Configurar Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: ./infra
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ secrets.TF_STATE_RG }}" \
            -backend-config="storage_account_name=${{ secrets.TF_STATE_STORAGE }}" \
            -backend-config="container_name=${{ secrets.TF_STATE_CONTAINER }}" \
            -backend-config="key=${{ env.TF_KEY }}"

      - name: Terraform Apply
        working-directory: ./infra
        env:
          TF_VAR_db_pass: ${{ secrets.DB_PASSWORD }}
        run: |
          terraform apply -auto-approve \
            -var="environment=${{ env.ENV_NAME }}" \
            -var="project_suffix=${{ env.PROJECT_SUFFIX }}" \
            -var="backend_image=${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

      # 4. Actualizar la Container App
      - name: Deploy to Azure Container Apps
        uses: azure/CLI@v1
        with:
          inlineScript: |
            APP_NAME="app-unified-${{ env.PROJECT_SUFFIX }}-${{ env.ENV_NAME }}"
            RG_NAME="rg-fastapi-${{ env.PROJECT_SUFFIX }}-${{ env.ENV_NAME }}"
            
            echo "Desplegando imagen ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }} en $APP_NAME..."
            
            az containerapp update \
              --name $APP_NAME \
              --resource-group $RG_NAME \
              --image ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}